<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Swoogo Image Generation Plugin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
    />
    <style>
      @font-face {
        font-family: "RigShaded";
        src: url("./fonts/rig-shaded/Rig_Shaded_Bold_Face.otf")
          format("opentype");
        font-weight: normal;
        font-style: normal;
      }

      @font-face {
        font-family: "AvenirBlack";
        src: url("./fonts/avenir-font/AvenirLTStd-Black.otf") format("opentype");
        font-weight: normal;
        font-style: normal;
      }

      @font-face {
        font-family: "AvenirLight";
        src: url("./fonts/avenir-font/AvenirLTStd-Medium.otf")
          format("opentype");
        font-weight: normal;
        font-style: normal;
      }

      :root {
        --red: #c82b2b;
        --green: #1cab1c;

        --orange: #ff6000;
        --orange-light: #ffdad4;
        --orange-overlay: #ff600099;

        --pink: #eb338d;
        --pink-light: #f9bed0;
        --pink-overlay: #eb338d99;

        --blue: #23438b;
        --blue-light: #d2d9f8;
        --blue-overlay: #23438b99;

        --yellow: #ffe608;
        --yellow-light: #fff9c9;
        --yellow-overlay: #ffe60899;

        --cyan: #50c0ae;
        --cyan-light: #c2fcf0;
        --cyan-overlay: #50c0ae99;

        --primary: var(--orange);
        --secondary: var(--orange-light);
        --overlay: var(--orange-overlay);

        --portrait: 500px;
        --landscape: 700px;
        --square: 600px;

        --max-width: var(--landscape);

        --bg-img: none;

        --participant-name-bottom-portrait: 10%;
        --participant-name-bottom-square: 10%;
        --participant-name-bottom-landscape: 15%;

        --participant-name-bottom: var(--participant-name-bottom-15);

        --share-event-details-padding-landscape: 90px 10px 20px 20px;
        --share-event-details-padding-portrait: 20px 10px 20px 20px;
        --share-event-details-padding-square: 20px 10px 20px 20px;

        --share-event-details-padding: var(
          --share-event-details-padding-landscape
        );
      }

      svg path {
        fill: var(--orange);
      }

      svg circle {
        fill: var(--orange);
      }

      svg rect {
        stroke: var(--orange);
      }

      .toast {
        position: fixed;
        top: -150vh;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 25px;
        border-radius: 5px;
        color: white;
        font-size: 16px;
        font-weight: bold;
        z-index: 1000;
        opacity: 0;
        transition: top 0.5s ease-in-out, opacity 0.5s ease-in-out;
      }

      .toast.red {
        background-color: var(--red);
      }

      .toast.green {
        background-color: var(--green);
      }

      .toast.show {
        top: 20px;
        opacity: 1;
      }

      .toast.hide {
        top: -50px;
        opacity: 0;
      }

      .share-event,
      .share-event * {
        margin: 0;
        padding: 0;
        max-width: var(--max-width);
      }

      .wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        max-width: var(--landscape);
        margin: 0 auto;
      }

      .share-event p,
      .share-event a,
      .share-event button,
      .toast,
      .role,
      .share-event-controls {
        font-family: "AvenirBlack", sans-serif !important;
      }

      select {
        font-family: "AvenirLight", sans-serif;
      }

      .cropper-btn {
        font-family: "AvenirBlack", sans-serif;
        background-color: var(--orange);
        color: #ffffff;
        padding: 10px 0;
        border: 1px solid transparent;
        border-radius: 10px;
        width: 100px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
      }

      .cropper-btn:hover {
        background-color: #ffffff;
        color: var(--orange);
        border-color: var(--orange-overlay);
      }

      .share-event-header > h3 {
        color: var(--orange);
        margin: 0;
        padding: 0;
      }

      .share-event h3,
      .share-event-header {
        font-family: "RigShaded", sans-serif;
        font-weight: 700;
        font-size: 20px;
        text-transform: uppercase;
        letter-spacing: 0.75px;
      }

      .share-event-date,
      .role {
        font-family: "AvenirBlack", sans-serif;
        text-transform: none;
        font-weight: 800;
      }

      .role {
        font-size: 20px;
      }

      .share-event p,
      .share-event a {
        font-size: 16px;
      }

      .share-event a {
        text-decoration: none;
        cursor: pointer;
        transition: color 0.15s ease-in-out;
      }

      .share-event a:hover {
        color: var(--orange);
      }

      .share-event-controls {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        width: 100%;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .share-event-controls > div {
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 0 10px;
      }

      .color-choice {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
      }

      .orange {
        background-color: var(--orange);
      }
      .pink {
        background-color: var(--pink);
      }
      .cyan {
        background-color: var(--cyan);
      }
      .blue {
        background-color: var(--blue);
      }
      .yellow {
        background-color: var(--yellow);
      }

      .role-chooser > select {
        border: 2px solid var(--orange);
        border-radius: 20px;
        padding: 5px 10px;
      }

      .orientation-chooser > * {
        cursor: pointer;
      }

      .orientation-chooser > .selected {
        border: 3px solid #000000;
      }

      .square-option,
      .landscape-option,
      .portrait-option {
        border: 2px solid #000000;
        border-radius: 5px;
      }
      .square-option {
        width: 24px;
        height: 24px;
      }
      .landscape-option {
        width: 40px;
        height: 24px;
      }
      .portrait-option {
        width: 24px;
        height: 36px;
        margin-bottom: auto;
      }

      .share-event-header {
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .share-event-header > .icon {
        cursor: pointer;
      }

      .share-event-content {
        background-color: var(--secondary);
        border-radius: 25px;
        display: flex;
        gap: 30px;
        width: fit-content;
        position: relative;
        flex-wrap: wrap-reverse;
      }

      .portrait {
        flex-direction: column-reverse;
      }
      .landscape {
        flex-direction: row;
      }
      .square {
        flex-direction: column-reverse;
      }

      .images-section {
        display: flex;
        gap: 40px;
      }

      .images-section > img {
        cursor: pointer;
      }

      .divider-section {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        width: 40%;
      }

      .white-divider {
        border-top: 1px solid #ffffff;
        width: 100%;
      }

      .black-divider {
        border-top: 1px solid #000000;
        width: 100%;
      }

      .white {
        color: #ffffff;
      }
      .black {
        color: #000000;
      }
      .small {
        font-size: 12px !important;
      }
      .bold {
        font-weight: 800 !important;
      }

      .download-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--overlay);
        border-radius: 25px;
        z-index: 1;
      }

      .share-event-details {
        flex: 2;
        padding: var(--share-event-details-padding);
      }

      @media (width < 450px) {
        .share-event-details > h3 {
          word-break: break-all;
        }
      }

      .share-event-details > h3 {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        padding: 10px;
      }

      .share-event-name {
        font-size: 25px;
        line-height: 1.4;
      }

      .share-event-logo {
        width: 110px;
        height: 60px;
      }

      .share-event-logo > img {
        width: 100%;
        height: 100%;
      }

      .share-event-images {
        flex: 1;
        position: relative;
        min-height: 320px;
        min-width: 240px;
      }

      .share-event-background-image {
        min-height: inherit;
        min-width: inherit;
        border-radius: 25px;
        height: 100%;
        width: 100%;
        position: relative;
      }

      .bg-img {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background-image: var(--bg-img);
        background-size: cover;
        background-position: center;
        border-radius: 25px;
        z-index: 0 !important;
      }

      .share-event-background-image > * {
        z-index: 1;
      }

      .share-event-profile-image {
        border-radius: 50%;
        width: 150px;
        height: 150px;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        cursor: pointer;
      }

      .profile-hover-overlay {
        display: flex;
        position: absolute;
        width: 150px;
        height: 150px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: #00000099;
        display: none;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        border-radius: 50%;
        z-index: 2;
      }

      .profile-hover-overlay > p {
        color: #ffffff;
        font-weight: 800;
      }

      .no-image-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: #d9d9d9;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #666;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        gap: 5px;
        padding: 10px;
      }

      .no-image-placeholder > p {
        cursor: pointer;
        transition: color 0.15s ease-in-out;
      }

      .no-image-placeholder > p:hover {
        color: var(--orange);
      }

      .event-share-participant-name {
        position: absolute;
        left: 0;
        bottom: var(--participant-name-bottom);
        width: 100%;
        text-align: center;
        color: #ffffff;
      }
    </style>
  </head>
  <body>
    <div id="toast" class="toast"></div>

    <div class="wrapper">
      <div class="share-event-header">
        <h3>Share you are attending</h3>
        <div class="share-actions">
          <a href="" id="downloadBtn">
            <svg
              width="19"
              height="19"
              viewBox="0 0 19 19"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g clip-path="url(#clip0_5_87)">
                <path
                  d="M12.825 10.1333C12.5083 9.81666 12.0333 9.81666 11.7167 10.1333L10.2917 11.5583V2.37499C10.2917 1.89999 9.975 1.58333 9.5 1.58333C9.025 1.58333 8.70833 1.89999 8.70833 2.37499V11.5583L7.28333 10.1333C6.96667 9.81666 6.49167 9.81666 6.175 10.1333C5.85833 10.45 5.85833 10.925 6.175 11.2417L8.94583 14.0125C9.10417 14.1708 9.34167 14.25 9.5 14.25C9.65833 14.25 9.89583 14.1708 10.0542 14.0125L12.825 11.2417C13.1417 10.925 13.1417 10.3708 12.825 10.1333Z"
                  fill="white"
                />
                <path
                  d="M14.2499 17.4167H4.74992C4.27492 17.4167 3.95825 17.1 3.95825 16.625C3.95825 16.15 4.27492 15.8333 4.74992 15.8333H14.2499C14.7249 15.8333 15.0416 16.15 15.0416 16.625C15.0416 17.1 14.7249 17.4167 14.2499 17.4167Z"
                  fill="white"
                />
              </g>
              <defs>
                <clipPath id="clip0_5_87">
                  <rect width="19" height="19" fill="white" />
                </clipPath>
              </defs>
            </svg>
          </a>
        </div>
      </div>
      <div class="share-event-controls">
        <div class="color-chooser">
          <p>Color:</p>
          <div class="orange color-choice"></div>
          <div class="pink color-choice"></div>
          <div class="cyan color-choice"></div>
          <div class="blue color-choice"></div>
          <div class="yellow color-choice"></div>
        </div>
        <div class="role-chooser">
          <p>Role:</p>
          <select class="role-selector" name="role" id="role">
            <option selected value="I'm attending">I'm attending</option>
            <option value="I'm participating in">I'm participating in</option>
            <option value="I'm speaking at">I'm speaking at</option>
            <option value="I'm sponsor of">I'm sponsor of</option>
            <option value="I'm nominated for">I'm nominated for</option>
          </select>
        </div>
        <div class="orientation-chooser">
          <p>Orientation:</p>
          <div class="square-option selected"></div>
          <div class="landscape-option"></div>
          <div class="portrait-option"></div>
        </div>
      </div>
      <section class="share-event">
        <div class="share-event-content landscape" id="eventContent">
          <div class="share-event-details">
            <h3>
              <span class="role">Loading...</span>
              <br />
              <span class="share-event-name">Loading...</span>
              <br />
              <span class="share-event-date">Loading...</span>
            </h3>
            <div class="share-event-logo">
              <img src="./images/logo.svg" alt="logo" />
            </div>
          </div>
          <div class="share-event-images">
            <div class="overlay"></div>
            <div class="share-event-background-image">
              <div class="bg-img"></div>
              <div class="profile-hover-overlay">
                <p>Remove</p>
              </div>
              <img
                class="share-event-profile-image"
                alt="profile-image"
                crossorigin="anonymous"
              />
              <h3 class="event-share-participant-name">loading...</h3>
            </div>
          </div>
        </div>
      </section>
    </div>
    <input
      type="file"
      id="profileImageInput"
      accept="image/*"
      style="display: none"
    />

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const elements = {
          profileImage: document.querySelector(".share-event-profile-image"),
          profileContainer: document.querySelector(
            ".share-event-background-image"
          ),
          fileInput: document.getElementById("profileImageInput"),
          hoverOverlay: document.querySelector(".profile-hover-overlay"),
          downloadBtn: document.getElementById("downloadBtn"),
          eventContent: document.getElementById("eventContent"),
          shareEventName: document.querySelector(".share-event-name"),
          shareEventDate: document.querySelector(".share-event-date"),
          shareEventContent: document.querySelector(".share-event-content"),
          participantName: document.querySelector(
            ".event-share-participant-name"
          ),
          colorChoices: document.querySelectorAll(".color-choice"),
          roleSelector: document.querySelector(".role-selector"),
          role: document.querySelector(".role"),
          orientationChooser: document.querySelector(".orientation-chooser"),
        };

        const config = {
          API_URL: "https://swoogo-image-generation-plugin-backend.vercel.app",
          clientId: "7712xqkqiwy7hu",
          eventId: 238288,
          registrantId: 50888253,
        };

        let state = {
          hasProfileImage: false,
          event: null,
          registrantDetails: null,
          registrantProfilePicture: null,
          swToken: null,
          isLoading: true,
          colorScheme: "orange",
          role: "I'm attending",
          orientation: "square",
        };

        const helpers = {
          formatDate(inputDate) {
            const date = new Date(inputDate);
            const options = {
              weekday: "long",
              day: "2-digit",
              month: "long",
              year: "numeric",
            };
            return date.toLocaleDateString("en-US", options);
          },

          createOverlay() {
            const overlay = document.createElement("div");
            overlay.className = "overlay";
            return overlay;
          },

          openCropper(imageSrc) {
            const cropperModal = document.createElement("div");
            cropperModal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000">
          <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; align-items: center;">
            <div style="width: 100%; max-height: 70vh; overflow: hidden; display: flex; justify-content: center;">
              <img id="cropperImage" src="${imageSrc}" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
            </div>
            <div style="margin-top: 10px;">
              <button id="cancelBtn" class="cropper-btn">Cancel</button>
              <button id="cropBtn" class="cropper-btn">Crop</button>
            </div>
          </div>
        </div>
      `;
            document.body.appendChild(cropperModal);

            const cropperImage = document.getElementById("cropperImage");
            const cropper = new Cropper(cropperImage, {
              aspectRatio: 1,
              viewMode: 2,
              responsive: true,
              scalable: false,
              zoomable: true,
              autoCropArea: 1,
            });

            document.getElementById("cropBtn").addEventListener("click", () => {
              const croppedCanvas = cropper.getCroppedCanvas();
              if (croppedCanvas) {
                const croppedImage = croppedCanvas.toDataURL();
                helpers.changeState("registrantProfilePicture", croppedImage);
                helpers.changeState("hasProfileImage", true);
                ui.setProfileImage(croppedImage);
              }
              document.body.removeChild(cropperModal);
              cropper.destroy();
            });

            document
              .getElementById("cancelBtn")
              .addEventListener("click", () => {
                document.body.removeChild(cropperModal);
                cropper.destroy();
              });
          },

          storeState() {
            sessionStorage.setItem("state", JSON.stringify(state));
          },

          getState() {
            res = JSON.parse(sessionStorage.getItem("state"));

            if (res) {
              state = res;
              return true;
            }

            return false;
          },

          changeState(key, value) {
            if (key in state) {
              state[key] = value;
              helpers.storeState();
            }
          },
        };

        const ui = {
          showLoadingState() {
            elements.profileImage.style.display = "none";
            elements.hoverOverlay.style.display = "none";

            const existingPlaceholder = document.querySelector(
              ".no-image-placeholder"
            );
            if (existingPlaceholder) {
              existingPlaceholder.remove();
            }

            const loadingDiv = document.createElement("div");
            loadingDiv.className = "no-image-placeholder loading-state";
            loadingDiv.innerHTML = `
              <div class="loading-spinner"></div>
              <p class="black small bold">Loading profile...</p>
            `;
            elements.profileContainer.appendChild(loadingDiv);
          },

          showUploadOption() {
            elements.profileImage.style.display = "none";
            elements.hoverOverlay.style.display = "none";
            helpers.changeState("hasProfileImage", false);
            helpers.changeState("registrantProfilePicture", null);

            const existingPlaceholder = document.querySelector(
              ".no-image-placeholder"
            );
            if (existingPlaceholder) {
              existingPlaceholder.remove();
            }

            const noImageDiv = document.createElement("div");
            noImageDiv.className = "no-image-placeholder";
            noImageDiv.innerHTML = `
              <img src="./images/upload-icon.svg">
              <p class="black small profile-img-input bold">Upload image</p>
              <p class="black-divider"></p>
              <p class="black small without-image bold">Without image</p>
            `;
            elements.profileContainer.appendChild(noImageDiv);

            noImageDiv.addEventListener("click", function (e) {
              const target = e.target;

              if (
                target.classList.contains("profile-img-input") ||
                target.closest(".profile-img-input")
              ) {
                elements.fileInput.click();
              } else if (
                target.classList.contains("without-image") ||
                target.closest(".without-image")
              ) {
                document.querySelector(".overlay").remove();
                noImageDiv.remove();
              }
            });
          },

          setProfileImage(imageUrl) {
            elements.profileImage.src = imageUrl;
            elements.profileImage.style.display = "block";
            helpers.changeState("hasProfileImage", true);

            const placeholder = document.querySelector(".no-image-placeholder");
            if (placeholder) placeholder.remove();
          },

          async downloadEventAsImage() {
            const noImagePlaceholder = document.querySelector(
              ".no-image-placeholder"
            );
            const profileImage = document.querySelector(
              ".share-event-profile-image"
            );
            const overlay = document.querySelector(".overlay");

            const originalStates = {
              noImagePlaceholder: noImagePlaceholder
                ? noImagePlaceholder.style.display
                : null,
              overlay: overlay?.style.display,
            };

            let profileImageParent = null;
            let profileImageNextSibling = null;
            let removedProfileImage = false;

            if (noImagePlaceholder) {
              noImagePlaceholder.style.display = "none";
              overlay.style.display = "none";
            }

            if (profileImage) {
              const src = profileImage.getAttribute("src");
              if (!src || src.trim() === "") {
                profileImageParent = profileImage.parentNode;
                profileImageNextSibling = profileImage.nextSibling;
                profileImageParent.removeChild(profileImage);
                removedProfileImage = true;
              }
            }

            try {
              const scale = 3;

              const style = {
                transform: `scale(${scale})`,
                transformOrigin: "top left",
                width: elements.eventContent.offsetWidth + "px",
                height: elements.eventContent.offsetHeight + "px",
              };

              const param = {
                width: elements.eventContent.offsetWidth * scale,
                height: elements.eventContent.offsetHeight * scale,
                style: style,
              };

              const dataUrl = await domtoimage.toPng(
                elements.eventContent,
                param
              );

              const link = document.createElement("a");
              link.download =
                removedProfileImage || !profileImage
                  ? "event-without-profile.png"
                  : "event-with-profile.png";
              link.href = dataUrl;
              link.click();
            } catch (error) {
              console.error(
                "An error occurred while generating the image:",
                error
              );
              throw error;
            } finally {
              if (noImagePlaceholder) {
                noImagePlaceholder.style.display =
                  originalStates.noImagePlaceholder;
                overlay.style.display = originalStates.overlay;
              }

              if (removedProfileImage && profileImageParent) {
                if (profileImageNextSibling) {
                  profileImageParent.insertBefore(
                    profileImage,
                    profileImageNextSibling
                  );
                } else {
                  profileImageParent.appendChild(profileImage);
                }
              }
            }
          },

          setupEventData(event, registrantDetails, registrantProfilePicture) {
            elements.shareEventName.textContent = event.name;
            elements.shareEventDate.textContent = helpers.formatDate(
              event.start_date
            );
            const root = document.documentElement;
            root.style.setProperty("--bg-img", `url('${event.c_96753}')`);

            elements.participantName.textContent = `${registrantDetails.first_name} ${registrantDetails.last_name}`;

            if (registrantProfilePicture) {
              ui.setProfileImage(registrantProfilePicture);
              helpers.changeState("hasProfileImage", true);
            } else {
              ui.showUploadOption();
            }

            helpers.changeState("isLoading", false);
          },

          showToast(message, color) {
            let toast = document.getElementById("toast");
            toast.className = "toast " + color + " show";
            toast.innerText = message;

            setTimeout(() => {
              toast.classList.add("hide");
            }, 2500);

            setTimeout(() => {
              toast.className = "toast";
            }, 3000);
          },

          changeColorScheme(color) {
            const root = document.documentElement;
            const primary = getComputedStyle(root)
              .getPropertyValue(`--${color}`)
              .trim();
            const secondary = getComputedStyle(root)
              .getPropertyValue(`--${color}-light`)
              .trim();
            const overlay = getComputedStyle(root)
              .getPropertyValue(`--${color}-overlay`)
              .trim();

            root.style.setProperty("--primary", primary);
            root.style.setProperty("--secondary", secondary);
            root.style.setProperty("--overlay", overlay);

            helpers.changeState("colorScheme", color);
          },

          changeRole(role, changeSelected = false) {
            elements.role.textContent = role;

            helpers.changeState("role", role);

            if (changeSelected) {
              options = elements.roleSelector.options;

              Array.from(options).forEach((option) => {
                if (option.text === role) {
                  option.selected = true;
                } else {
                  option.selected = false;
                }
              });
            }
          },

          changeOrientation(orientation) {
            const availableOrientations = ["landscape", "portrait", "square"];

            if (!availableOrientations.includes(orientation)) {
              return;
            }

            if (elements.shareEventContent.classList.length > 1) {
              const keep = elements.shareEventContent.classList[0];
              elements.shareEventContent.className = keep;
            }

            elements.shareEventContent.classList.add(orientation);

            const root = document.documentElement;
            const width = getComputedStyle(root)
              .getPropertyValue(`--${orientation}`)
              .trim();
            const bottom = getComputedStyle(root)
              .getPropertyValue(`--participant-name-bottom-${orientation}`)
              .trim();
            const topPadding = getComputedStyle(root)
              .getPropertyValue(`--share-event-details-padding-${orientation}`)
              .trim();

            root.style.setProperty("--max-width", width);
            root.style.setProperty("--participant-name-bottom", bottom);
            root.style.setProperty("--share-event-details-padding", topPadding);

            const children = Array.from(elements.orientationChooser.children);
            children.shift();

            children.forEach((child) => {
              if (child.classList[0].split("-")[0] === orientation) {
                child.classList.add("selected");
              } else {
                child.classList.remove("selected");
              }
            });

            helpers.changeState("orientation", orientation);
          },
        };

        const api = {
          async getToken() {
            try {
              const response = await fetch(`${config.API_URL}/get-token`, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
              });

              if (!response.ok)
                throw new Error(`HTTP error! Status: ${response.status}`);
              const data = await response.json();
              return data?.access_token;
            } catch (error) {
              console.error("Error fetching token:", error);
              return null;
            }
          },

          async fetchWithAuth(endpoint) {
            try {
              const response = await fetch(`${config.API_URL}${endpoint}`, {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${state.swToken}`,
                },
              });

              if (!response.ok)
                throw new Error(`HTTP error! Status: ${response.status}`);
              return await response.json();
            } catch (error) {
              console.error(`Error fetching ${endpoint}:`, error);
              return null;
            }
          },

          getEventDetailsById(eventId) {
            return api.fetchWithAuth(`/event/${eventId}`);
          },

          getRegistrantsByEventId(eventId) {
            return api
              .fetchWithAuth(`/registrants/${eventId}`)
              .then((data) => data?.items || []);
          },

          getRegistrantDetailsById(registrantId) {
            return api.fetchWithAuth(`/registrant/${registrantId}`);
          },

          getObjectAssetsByObjectId(object, objectId, asset) {
            return api.fetchWithAuth(`/image/${object}/${objectId}/${asset}`);
          },
        };

        function setupEventListeners() {
          elements.downloadBtn.addEventListener("click", (e) => {
            e.preventDefault();
            ui.downloadEventAsImage();
          });

          elements.fileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => helpers.openCropper(e.target.result);
              reader.readAsDataURL(file);
            }
          });

          elements.profileImage.addEventListener("mouseenter", () => {
            if (elements.profileImage.style.display === "block") {
              elements.hoverOverlay.style.display = "flex";
            }
          });

          elements.hoverOverlay.addEventListener("mouseenter", () => {
            if (elements.profileImage.style.display === "block") {
              elements.hoverOverlay.style.display = "flex";
            }
          });

          elements.profileImage.addEventListener("mouseleave", (e) => {
            if (!e.relatedTarget || e.relatedTarget !== elements.hoverOverlay) {
              setTimeout(() => {
                if (!elements.hoverOverlay.matches(":hover")) {
                  elements.hoverOverlay.style.display = "none";
                }
              }, 50);
            }
          });

          elements.hoverOverlay.addEventListener("mouseleave", () => {
            elements.hoverOverlay.style.display = "none";
          });

          elements.hoverOverlay.addEventListener("click", ui.showUploadOption);

          elements.colorChoices.forEach((colorChoice) => {
            colorChoice.addEventListener("click", (e) => {
              const color = colorChoice.classList[0];
              ui.changeColorScheme(color);
            });
          });

          elements.roleSelector.addEventListener("change", () => {
            ui.changeRole(elements.roleSelector.value);
          });

          elements.orientationChooser.addEventListener("click", (e) => {
            const orientation = e.target.classList[0].split("-")[0];

            ui.changeOrientation(orientation);
          });
        }

        async function init() {
          const isFound = helpers.getState();
          setupEventListeners();
          ui.changeColorScheme(state.colorScheme);
          ui.changeRole(state.role, true);
          ui.changeOrientation(state.orientation);

          if (isFound && !state.isLoading) {
            ui.setupEventData(
              state.event,
              state.registrantDetails,
              state.registrantProfilePicture
            );

            return;
          } else {
            ui.showLoadingState();
          }

          const swToken = await api.getToken();
          if (!swToken) {
            ui.showUploadOption();
            return;
          } else {
            helpers.changeState("swToken", swToken);
          }

          const event = await api.getEventDetailsById(config.eventId);
          if (!event) {
            ui.showUploadOption();
            return;
          } else {
            helpers.changeState("event", event);
          }

          const registrants = await api.getRegistrantsByEventId(config.eventId);
          if (!registrants.length) {
            ui.showUploadOption();
            return;
          }

          const registrantDetails = await api.getRegistrantDetailsById(
            config.registrantId
          );
          if (!registrantDetails) {
            ui.showUploadOption();
            return;
          } else {
            helpers.changeState("registrantDetails", registrantDetails);
          }

          const registrantProfilePicture = await api.getObjectAssetsByObjectId(
            "registrant",
            config.registrantId,
            "profile_picture"
          );

          helpers.changeState(
            "registrantProfilePicture",
            registrantProfilePicture
          );

          ui.setupEventData(event, registrantDetails, registrantProfilePicture);
        }

        init();
      });
    </script>
  </body>
</html>
